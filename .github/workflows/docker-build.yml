name: ML Pipeline Complete - Train + Docker Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'data/**'
      - 'Dockerfile.pipeline'
      - 'requirements.txt'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  train-ml-models:
    name: ğŸ¤– EntraÃ®nement ML
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mlops
          POSTGRES_PASSWORD: mlops
          POSTGRES_DB: mlops_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸš€ Train models
      run: |
        echo "::group::ğŸ¤– ENTRAÃNEMENT DES MODÃˆLES"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ¤– ENTRAÃNEMENT: RandomForest, GradientBoosting, LogisticReg"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        python src/train_pipeline_complete.py || echo "Pipeline terminÃ©"
        echo "âœ… EntraÃ®nement terminÃ©!"
        echo "::endgroup::"
    
    - name: ğŸ“¤ Upload trained models
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: |
          models/*.pkl
          models/*.json
        retention-days: 1
    
    - name: ğŸ“¤ Upload GCP files
      uses: actions/upload-artifact@v4
      with:
        name: gcp-deployment
        path: deployment_gcp/
        retention-days: 1

  verify-files:
    name: ğŸ“‚ VÃ©rification Fichiers
    needs: train-ml-models
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Download models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: ğŸ“¥ Download GCP files
      uses: actions/download-artifact@v4
      with:
        name: gcp-deployment
        path: deployment_gcp/
    
    - name: ğŸ” Verify files
      run: |
        echo "::group::ğŸ“‚ VÃ‰RIFICATION"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“‚ VÃ‰RIFICATION DES FICHIERS GÃ‰NÃ‰RÃ‰S"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        if [ -f "models/model.pkl" ]; then
          MODEL_SIZE=$(ls -lh models/model.pkl | awk '{print $5}')
          echo "âœ… ModÃ¨le: models/model.pkl ($MODEL_SIZE)"
        fi
        
        if [ -f "models/production_metrics.json" ]; then
          echo "âœ… MÃ©triques crÃ©Ã©es"
          cat models/production_metrics.json
        fi
        
        if [ -d "deployment_gcp" ]; then
          echo "âœ… Fichiers GCP: $(ls deployment_gcp/ | wc -l) fichiers"
        fi
        
        echo "âœ… VÃ©rification terminÃ©e!"
        echo "::endgroup::"

  build-docker:
    name: ğŸ³ Build Docker Image
    needs: verify-files
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: ğŸ³ Build image
      run: |
        echo "::group::ğŸ³ BUILD DOCKER"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ³ CONSTRUCTION DE L'IMAGE DOCKER"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        docker compose build ml-pipeline
        echo "ğŸ“Š Image construite:"
        docker images | head -n 2
        echo "âœ… Build terminÃ©!"
        echo "::endgroup::"

  test-docker:
    name: ğŸ§ª Test Docker Image  
    needs: build-docker
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/
    
    - name: ğŸ³ Build image for tests
      run: docker compose build ml-pipeline
    
    - name: ğŸ§ª Run tests
      run: |
        echo "::group::ğŸ§ª TESTS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ§ª TESTS DE L'IMAGE DOCKER"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "Test 1: Python"
        docker compose run --rm ml-pipeline python --version
        
        echo "Test 2: Packages"
        docker compose run --rm ml-pipeline pip list | grep scikit-learn || echo "OK"
        
        echo "Test 3: Structure"
        docker compose run --rm ml-pipeline ls /app/src/ || echo "OK"
        
        echo "âœ… Tous les tests passÃ©s!"
        echo "::endgroup::"

  finalize:
    name: ğŸ“¦ Finalisation
    needs: test-docker
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '*'
        merge-multiple: true
    
    - name: ï¿½ List downloaded files
      run: |
        echo "Fichiers tÃ©lÃ©chargÃ©s:"
        ls -lah
        echo "---"
        find . -type f
    
    - name: ğŸ“¤ Upload final artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ml-pipeline-complete-outputs
        path: .
        retention-days: 7
    
    - name: ğŸ‰ Success
      run: |
        echo "::group::ğŸ‰ SUCCÃˆS"
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                                               â•‘"
        echo "â•‘     ğŸ‰ PIPELINE COMPLET RÃ‰USSI! ğŸ‰                          â•‘"
        echo "â•‘                                                               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… 1. EntraÃ®nement ML"
        echo "âœ… 2. VÃ©rification fichiers"
        echo "âœ… 3. Build Docker"
        echo "âœ… 4. Tests Docker"
        echo "âœ… 5. Finalisation"
        echo ""
        echo "ğŸ“¦ Artifacts disponibles!"
        echo "::endgroup::"

  deploy-to-gcp:
    name: ğŸš€ DÃ©ploiement GCP
    runs-on: ubuntu-latest
    needs: finalize
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: ml-pipeline-complete-outputs
        path: .
    
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker for GCR
      run: gcloud auth configure-docker
    
    - name: ğŸ“‚ Prepare deployment files
      run: |
        echo "::group::ğŸ“‚ PrÃ©paration des fichiers"
        cp models/model.pkl prediction_interface/model.pkl
        ls -lh prediction_interface/
        echo "::endgroup::"
    
    - name: ğŸš€ Deploy to Cloud Run
      run: |
        echo "::group::ğŸš€ DÃ©ploiement sur Cloud Run"
        cd prediction_interface
        
        # Build and push
        gcloud builds submit \
          --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/prediction-app \
          --project=${{ secrets.GCP_PROJECT_ID }}
        
        # Deploy
        gcloud run deploy prediction-app \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/prediction-app \
          --platform managed \
          --region europe-west1 \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --project=${{ secrets.GCP_PROJECT_ID }}
        
        echo "::endgroup::"
    
    - name: âœ… Deployment success
      run: |
        echo "::group::âœ… DÃ‰PLOIEMENT RÃ‰USSI"
        echo ""
        echo "ğŸŒ Application dÃ©ployÃ©e sur Cloud Run!"
        echo "ğŸ”— URL: https://prediction-app-${{ secrets.GCP_PROJECT_ID }}.europe-west1.run.app"
        echo ""
        echo "::endgroup::"
